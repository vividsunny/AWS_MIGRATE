jQuery(document).ready(function(e){"use strict";function a(a,i){var _=e(a),n=_.data("rule_id"),c=_.find(".rule_head"),o=_.find(".rule_options"),d=c.find("label.rule_title").text();i&&(r.append(_),o.show(),l()),c.on("click",function(e){o.slideToggle()}),_.trigger("init_tooltips");var s=o.find("div.rule_type_block"),u=o.find("div.role_selector_block");u.hide();var f=o.find("div.replace_role_block");f.hide();var p=o.find("div.rule_radio_group");p.hide();var y=o.find("div.specific_product_block");y.hide();var m=o.find("div.specific_range_block");m.hide();var w=o.find("div.specific_taxonomy_block");w.hide();var h=w.find("div.category_search_block");h.hide();var v=w.find("div.tag_search_block");v.hide();var g=o.find("div.date_range_block");g.hide();var k=o.find("div.duration_block");k.hide();var b=o.find("div.role_filter_selector_block");b.hide();var j=o.find("div.submit_block");j.hide();var D=m.find('input[name="price_range_from"]'),C=m.find('input[name="price_range_to"]'),z=g.find(".sale_price_dates_from"),x=g.find(".sale_price_dates_to"),S=k.find(".ywarc_duration"),F=function(e){"role_selector"!=e&&"all"!=e||(u.removeClass("empty_field"),f.removeClass("empty_field")),"product_selector"!=e&&"all"!=e||y.removeClass("empty_field"),"price_range"!=e&&"all"!=e||(m.removeClass("empty_field"),m.removeClass("ywarc_from_gt_to")),"category"!=e&&"all"!=e||(h.removeClass("empty_field"),w.removeClass("empty_field")),"tag"!=e&&"all"!=e||(v.removeClass("empty_field"),w.removeClass("empty_field"))};D.on("change",function(){F("price_range")}),C.on("change",function(){F("price_range")}),o.find(".sale_price_dates_fields").each(function(){var a=e(this).find("input").datepicker({defaultDate:"",dateFormat:"yy-mm-dd",numberOfMonths:1,showButtonPanel:!0,onSelect:function(l){var r=e(this).is(".sale_price_dates_from")?"minDate":"maxDate",t=e(this).data("datepicker"),i=e.datepicker.parseDate(t.settings.dateFormat||e.datepicker._defaults.dateFormat,l,t.settings);a.not(this).datepicker("option",r,i)}})}),o.find("input.ywarc_rule_type_radio_button").change(function(){var e=o.find("input.ywarc_rule_type_radio_button:checked");"add"==e.val()?(f.hide(),u.slideDown(),p.show()):"replace"==e.val()&&(f.slideDown(),u.hide(),p.show())}).change(),o.find("input.ywarc_rule_radio_button").change(function(){F("all");var e=o.find("input.ywarc_rule_radio_button:checked");"product"==e.val()?(m.hide(),w.hide(),y.slideDown(),g.slideDown(),k.slideDown(),b.slideDown(),j.slideDown()):"range"==e.val()?(y.hide(),w.hide(),m.slideDown(),g.slideDown(),k.slideDown(),b.slideDown(),j.slideDown()):"overall"==e.val()?(y.hide(),w.hide(),m.slideDown(),g.slideDown(),k.slideDown(),b.slideDown(),j.slideDown()):"taxonomy"==e.val()&&(y.hide(),m.hide(),w.slideDown(),g.slideDown(),k.slideDown(),b.slideDown(),j.slideDown())}).change(),w.find("input.ywarc_tax_radio_button").change(function(){F("all");var e=w.find("input.ywarc_tax_radio_button:checked");"category"==e.val()?(v.hide(),h.show()):"tag"==e.val()&&(h.hide(),v.show())}).change();var I;I=localize_js_ywarc_admin.before_2_7?{maximumSelectionSize:1}:{maximumSelectionLength:1},o.find(".ywarc_role_selector, .ywarc_replace_role_before, .ywarc_replace_role_after").select2(I).on("change",function(){F("role_selector")}),b.find(".role_filter_selector").select2(),e(document.body).trigger("wc-enhanced-select-init"),e(":input.wc-product-search").on("change",function(){F("product_selector")});var M=function(a){var l=[];return a&&e.each(a,function(e,a){l.push({id:e,text:a})}),{results:l}},L=function(a,l){var r=e.parseJSON(a.attr("data-selected")),t=[];return e(a.val().split(",")).each(function(e,a){t.push({id:a,text:r[a]})}),l(t)},T=function(e){return'<div class="selected-option" data-id="'+e.id+'">'+e.text+"</div>"};e(":input.ywarc-category-search").filter(":not(.enhanced)").each(function(){var a={url:localize_js_ywarc_admin.ajax_url,dataType:"json",quietMillis:250,data:function(e){return{term:e,action:"ywarc_category_search",security:localize_js_ywarc_admin.search_categories_nonce}},cache:!0};localize_js_ywarc_admin.before_2_7?a.results=M:a.processResults=M;var l={initSelection:localize_js_ywarc_admin.before_2_7?L:null,formatSelection:localize_js_ywarc_admin.before_2_7?T:null,multiple:e(this).data("multiple"),allowClear:!!e(this).data("allow_clear"),placeholder:e(this).data("placeholder"),minimumInputLength:e(this).data("minimum_input_length")?e(this).data("minimum_input_length"):"3",escapeMarkup:function(e){return e},ajax:a};e(this).select2(l).addClass("enhanced").on("change",function(){F("category")})}),e(":input.ywarc-tag-search").filter(":not(.enhanced)").each(function(){var a={url:localize_js_ywarc_admin.ajax_url,dataType:"json",quietMillis:250,data:function(e){return{term:e,action:"ywarc_tag_search",security:localize_js_ywarc_admin.search_tags_nonce}},cache:!0};localize_js_ywarc_admin.before_2_7?a.results=M:a.processResults=M;var l={initSelection:localize_js_ywarc_admin.before_2_7?L:null,formatSelection:localize_js_ywarc_admin.before_2_7?T:null,multiple:e(this).data("multiple"),allowClear:!!e(this).data("allow_clear"),placeholder:e(this).data("placeholder"),minimumInputLength:e(this).data("minimum_input_length")?e(this).data("minimum_input_length"):"3",escapeMarkup:function(e){return e},ajax:a};e(this).select2(l).addClass("enhanced").on("change",function(){F("tag")})}),j.find("input").on("click",function(a){a.preventDefault(),_.block({message:null,overlayCSS:{background:"#fff",opacity:.6}});var r=s.find("input.ywarc_rule_type_radio_button:checked").val(),c=u.find("select.ywarc_role_selector").val(),g=f.find("select.ywarc_replace_role_before").val(),k=f.find("select.ywarc_replace_role_after").val(),j=o.find("input.ywarc_rule_radio_button:checked").val(),F=y.find(':input[id^="ywarc_product_selector"]').val(),I=D.val(),M=C.val(),L=w.find("input.ywarc_tax_radio_button:checked").val(),T=h.find(':input[id^="ywarc_category_selector"]').val(),q=v.find(':input[id^="ywarc_tag_selector"]').val(),O=z.val(),R=x.val(),A=S.val(),B=b.find("select.role_filter_selector").val(),J=!0;if("add"==r?c||(J=!1,u.addClass("empty_field")):"replace"==r?g&&k||(J=!1,f.addClass("empty_field")):(J=!1,s.addClass("empty_field")),"product"==j?F||(J=!1,y.addClass("empty_field")):"range"==j||"overall"==j?(I||M||(J=!1,m.addClass("empty_field")),M&&parseInt(I)>=parseInt(M)&&(J=!1,m.addClass("ywarc_from_gt_to"))):"taxonomy"==j?"category"==L?T||(J=!1,h.addClass("empty_field")):"tag"==L?q||(J=!1,v.addClass("empty_field")):(J=!1,w.addClass("empty_field")):(J=!1,p.addClass("empty_field")),J){A=(A=parseInt(A,10))>0?A:"";var N={action:"ywarc_save_rule",title:d,rule_id:n,rule_type:r,role_selected:c||"",replace_roles:g&&k?[g,k]:"",radio_group:j,product_selected:"product"===j?F:"",price_range_from:"range"===j||"overall"===j?I:"",price_range_to:"range"===j||"overall"===j?M:"",tax_radio_group:"taxonomy"===j?L:"",categories_selected:"taxonomy"===j&&"category"===L?T:"",tags_selected:"taxonomy"===j&&"tag"===L?q:"",date_from:O,date_to:R,duration:A,role_filter:B};e.post(localize_js_ywarc_admin.ajax_url,N,function(a){_.unblock(),i&&(t.append(_),o.hide(),i=!1),t.find(".rule_block").length>0&&e("#my_rules_header").removeClass("no_rules"),l()})}else _.unblock();l()}),j.find("a.delete_rule").on("click",function(a){if(a.preventDefault(),1==confirm(localize_js_ywarc_admin.delete_rule_msg)){if(i)_.remove();else{_.block({message:null,overlayCSS:{background:"#fff",opacity:.6}});var r={action:"ywarc_delete_rule",rule_id:n};e.post(localize_js_ywarc_admin.ajax_url,r,function(a){_.unblock(),_.remove(),0==t.find(".rule_block").length&&e("#my_rules_header").addClass("no_rules")})}0==t.find(".rule_block").length&&e("#my_rules_header").addClass("no_rules")}l()})}function l(){r.find(".rule_block").length>0?e("#ywarc_new_rules_row").removeClass("no_rules"):e("#ywarc_new_rules_row").addClass("no_rules")}var r=e(document).find(".ywarc_new_rules"),t=e(document).find(".ywarc_rules_group"),i=e("#yith_ywarc_add_rule_button"),_=e(".ywarc_new_rule_title"),n=e(".ywarc_creating_rule");_.focus(),_.keydown(function(e){13==e.which&&(i.focus(),i.trigger("click"))}),i.on("click",function(l){l.preventDefault();var t=_.val().trim(),i=[];r.find(".rule_title").each(function(){i.push(e(this).text())}),"-1"!=e.inArray(t,i)?(alert(localize_js_ywarc_admin.duplicated_name_msg),_.val(""),_.focus()):""==t?(alert(localize_js_ywarc_admin.empty_name_msg),_.focus()):(n.block({message:null,overlayCSS:{background:"#f1f1f1",opacity:.6}}),e.post(localize_js_ywarc_admin.ajax_url,{action:"ywarc_add_rule",title:t},function(e){n.unblock(),_.val(""),"duplicated_name_error"===e?(alert(localize_js_ywarc_admin.duplicated_name_msg),_.focus()):a(e,!0)}))}),e(".rule_block").each(function(e,l){a(l,!1)}),e("#show_all_rules").on("click",function(e){e.preventDefault(),t.find(".rule_options").slideDown()}),e("#hide_all_rules").on("click",function(e){e.preventDefault(),t.find(".rule_options").slideUp()}),e("#delete_all_rules").on("click",function(a){a.preventDefault(),1==confirm(localize_js_ywarc_admin.delete_all_rules_msg)&&(n.block({message:null,overlayCSS:{background:"#f1f1f1",opacity:.6}}),e.post(localize_js_ywarc_admin.ajax_url,{action:"ywarc_delete_all_rules"},function(a){n.unblock(),t.find(".rule_block").remove(),e("#my_rules_header").addClass("no_rules")})),l()}),e("#ywarc_force_apply_rules_set_dates_button").on("click",function(a){a.preventDefault(),e(".ywarc_force_apply_rules_dates").toggle(400)});var c=e("#ywarc_force_apply_rules_from_date").datepicker({defaultDate:"",dateFormat:"yy-mm-dd",maxDate:0}),o=e("#ywarc_force_apply_rules_to_date").datepicker({defaultDate:"",dateFormat:"yy-mm-dd",maxDate:0});c.datepicker("option","onSelect",function(e){o.datepicker("option","minDate",e)}),o.datepicker("option","onSelect",function(e){c.datepicker("option","maxDate",e)}),e("#ywarc_force_apply_rules").on("click",function(a){a.preventDefault();var l="none"===e(".ywarc_force_apply_rules_dates").css("display"),r=localize_js_ywarc_admin.force_apply_rules_warning+" ",t={action:"ywarc_force_apply_rules",security:localize_js_ywarc_admin.force_apply_rules_nonce,ywarc_find_all_orders:l?"1":"0"};if(l)r+=localize_js_ywarc_admin.force_apply_all_rules;else{var i=e("[name='ywarc_force_apply_rules_set_date_type']:checked").val(),_=c.val()?c.val():"",n=o.val()?o.val():"";t.ywarc_date_type=i,t.ywarc_from=_,t.ywarc_to=n,_||n?_&&n?r+=localize_js_ywarc_admin.force_apply_date_range_rules:_&&!n?r+=localize_js_ywarc_admin.force_apply_date_from_rules:!_&&n&&(r+=localize_js_ywarc_admin.force_apply_date_to_rules):r+=localize_js_ywarc_admin.force_apply_all_rules,r=(r=r.replace("{date_from}",_)).replace("{date_to}",n)}if(_&&n&&_>n)alert(localize_js_ywarc_admin.force_apply_rules_dates_warning);else if(window.confirm(r)){var d=e("span.ywarc_creating_rule.ywarc_force_apply_rules_row");d.block({message:null,overlayCSS:{background:"#f1f1f1",opacity:.6}}),e.post(localize_js_ywarc_admin.ajax_url,t,function(e){e.success||"from_date_gt_to_date_error"!==e.data||alert(localize_js_ywarc_admin.force_apply_rules_dates_warning),d.unblock()})}})});
!function(f,m,r){var e="ylc_console",t="plugin_"+e,a={app_id:"",user_info:{user_id:null,user_name:null,user_email:null,gravatar:null,user_type:null,avatar_type:null,avatar_image:null,current_page:null,user_ip:null}},s={show_chat_timer:function(a){var s=this;s.data.ref_cnv.child(a).once("value",function(e){if(null!==e.val()){var t=e.val();""==t.accepted_at?s.data.ref_cnv.child(a).child("accepted_at").set(Firebase.ServerValue.TIMESTAMP,function(){s.data.ref_cnv.child(a).once("value",function(e){if(null!==e.val()){var t=e.val();s.trigger_premium("set_timer",t.accepted_at)}})}):s.trigger_premium("set_timer",t.accepted_at)}})},premium_console:function(){var e=this;f(".macro-select").select2({placeholder:e.strings.msg.macro_title,allowClear:!0}),f(".macro-select").on("change",function(e){var t=f(this).val();if(""!=t&&null!=t){var a=f("#YLC_cnv_reply"),s=a.val();a.val(s+t),f(this).select2("val",""),a.trigger("autosize.resize").focus()}});var t=["connected","disconnected","online","offline","new-msg"];for(i=0;i<t.length;++i){var a=r.createElement("source"),s=t[i],n=ylc.plugin_url+"/sounds/"+s;e.sounds[s]=r.createElement("audio"),e.sounds[s].canPlayType("audio/mpeg;")?(a.type="audio/mpeg",a.src=n+".mp3"):(a.type="audio/ogg",a.src=n+".ogg"),e.sounds[s].appendChild(a)}},set_timer:function(a){var s=this;s.objs.list_interval=setInterval(function(){var e=new Date,t=s.trigger_premium("chat_duration",a,e.getTime());f("#YLC_timer").html(t),f("#YLC_cnv_reply").is(":disabled")&&clearInterval(s.objs.list_interval)},1e3)},end_chat_console:function(e,t,a,s,i){var n=this;this.trigger_premium("save_user_data",e,t,a,t,function(e){n.objs.working=!1,s.removeClass("button-disabled"),e.error?i.html(e.error):i.html(e.msg),setTimeout(function(){i.fadeOut(2e3),i.html()},1e3),t&&setTimeout(function(){n.show_welcome_popup()},3e3)})},play_sound:function(e){this.sounds[e].play()},chat_duration:function(e,t){if(""==t||""==e)return"00:00:00";var a=.001*(t-e)>>0,s=a/60>>0,i=s/60>>0;return(i=(i%=60)<10?"0"+i:i)+":"+(s=(s%=60)<10?"0"+s:s)+":"+(a=(a%=60)<10?"0"+a:a)},save_user_data:function(o,_,i,c,d){var u=this;this.data.ref_cnv.child(o).once("value",function(e){var t=null!==e.val(),a=e.val();if(t){var r=a.user_id,s=u.trigger_premium("chat_duration",a.accepted_at,i);u.data.ref_users.child(r).once("value",function(e){var n=e.val();n.created_at=a.created_at,n.evaluation=a.evaluation,n.duration=s,n.receive_copy=a.receive_copy,n.send_email=c,u.data.ref_msgs.once("value",function(e){var t=e.val(),a=t?Object.keys(t).length:0,s=0,i={};t?f.each(t,function(e,t){s+=1,t.conversation_id===o&&(i[e]=t,_&&u.data.ref_msgs.child(e).remove()),a===s&&(n.msgs=i,u.post("ylc_ajax_save_chat",n,function(e){d&&d(e)}))}):d&&d({}),_&&(u.data.ref_users.child(r).remove(),u.data.ref_cnv.child(o).remove())})})}else d&&d({})})},set_avatar_premium:function(e,t){if("admin"!=e)return"https://www.gravatar.com/avatar/"+t.gravatar+".jpg?s=60&d="+ylc.default_user_avatar;switch(t.avatar_type){case"gravatar":return"https://www.gravatar.com/avatar/"+t.gravatar+".jpg?s=60&d="+ylc.default_admin_avatar;case"image":return t.avatar_image;default:return""!=ylc.company_avatar?ylc.company_avatar:this.data.assets_url+"/images/default-avatar-"+e+".png"}}};function n(){this.opts=f.extend(a,ylc.defaults),this.premium=f.extend({},s)}n.prototype={init:function(){this.data={auth:null,ref:null,is_mobile:!1,active_user_id:0,mode:"offline",logged:!1,assets_url:ylc.plugin_url,user:{},online_ops:{}},this.strings=ylc.strings,this.sounds={},this.objs={last_cnv_id:null,last_user_id:null,last_msg_id:null,right_sidebar_html:"",list_interval:null,working:!1,checked_user_ids:[],new_msgs_count:{}};var t=this;f("#YLC_connect").click(function(e){e.preventDefault(),f("#YLC_notify").show().html(t.strings.msg.connecting+"..."),f(this).data("logged")?f(this).data("status","online")&&t.be_offline():t.login(!0)}),/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)&&(this.data.is_mobile=!0),this.post("ylc_ajax_get_token",{},function(e){e.error||(t.data.auth_token=e.token,t.check_ntf(),t.auth())})},auth:function(e){this.opts.app_id?(null==this.data.ref&&(this.data.ref=new Firebase("https://"+this.opts.app_id+".firebaseIO.com"),this.data.ref_conn=new Firebase("https://"+this.opts.app_id+".firebaseIO.com/.info/connected"),this.data.ref_cnv=new Firebase("https://"+this.opts.app_id+".firebaseIO.com/chat_sessions"),this.data.ref_msgs=new Firebase("https://"+this.opts.app_id+".firebaseIO.com/chat_messages"),this.data.ref_users=new Firebase("https://"+this.opts.app_id+".firebaseIO.com/chat_users"),this.data.ref_admins=new Firebase("https://"+this.opts.app_id+".firebaseIO.com/active_admins")),this.login(!1,e),this.after_load()):console.error("App ID not provided")},after_load:function(){var n=this;f(r).on("keydown","#YLC_cnv_reply",function(){f(this).trigger("autosize.resize"),f(m).trigger("resize")}),f(r).on("focus","#YLC_cnv_reply",function(){f(this).autosize({append:""})}),f(r).on("click","#YLC_users li.free, #YLC_users li.busy",function(){var t=f(this);null!=n.objs.list_interval&&clearInterval(n.objs.list_interval),n.get_user_data(f(this).data("id"),function(e){n.data.active_user_id&&f("#YLC_chat_user_"+n.data.active_user_id).removeClass("chat-active"),t.addClass("chat-active").removeClass("new-msg").data("count",0).find(".chat-count").empty(),f("#YLC_popup_cnv").removeClass("chat-welcome"),f("#YLC_cnv_reply").val("").focus().removeAttr("disabled"),f(".chat-cnv-input").removeClass("chat-disabled"),f(".sidebar-info.info-name > span").html(e.user_name),f(".sidebar-info.info-ip > span").html(e.user_ip),f(".sidebar-info.info-email > a").html(e.user_email).attr("href","mailto:"+e.user_email),f(".sidebar-info.info-page > a").html(e.current_page?e.current_page:"N/A").attr("href",e.current_page?e.current_page:"#"),f("#YLC_end_chat").attr("data-cnv-id",t.data("cnv-id")),f("#YLC_save").attr("data-cnv-id",t.data("cnv-id")),f("#YLC_active_cnv").val(t.data("cnv-id")),n.objs.cnv=f("#YLC_cnv"),n.objs.cnv.html(""),n.data.user.conversation_id=t.data("cnv-id"),n.data.active_user_id=t.data("id"),n.reload_cnv(t.data("cnv-id")),n.manage_reply_box(n.objs.last_cnv_id),n.objs.last_cnv_id=t.data("cnv-id"),n.objs.cnv.show(),f("#YLC_cnv_bottom .user-avatar img").attr("src",n.set_avatar(n.data.user.user_type,{gravatar:n.data.user.gravatar,avatar_type:n.data.user.avatar_type,avatar_image:n.data.user.avatar_image})),f("#YLC_cnv_bottom").show(),f("#YLC_sidebar_right").show(),"free"==t.data("chat")?n.data.ref_users.child(t.data("id")).child("chat_with").set(n.data.user.user_id):t.data("chat")==n.data.user.user_id?f("#YLC_end_chat").show():f("#YLC_end_chat").hide(),n.trigger_premium("show_chat_timer",t.data("cnv-id")),f(m).trigger("resize")})}),f(r).on("click","#YLC_save, #YLC_end_chat",function(e){var t=f(this),a=f("#YLC_save_ntf"),s="YLC_end_chat"===f(this).attr("id"),i=(new Date).getTime();a.show(),n.objs.working?a.html(n.strings.msg.please_wait+"..."):(n.objs.working=!0,f(this).addClass("button-disabled"),a.html(n.strings.msg.saving+"..."),s&&null!=n.objs.list_interval&&clearInterval(n.objs.list_interval),ylc.is_premium?n.trigger_premium("end_chat_console",f("#YLC_active_cnv").val(),s,i,t,a):n.clear_user_data(f("#YLC_active_cnv").val(),function(){n.objs.working=!1,t.removeClass("button-disabled"),setTimeout(function(){a.fadeOut(500)},100),setTimeout(function(){n.show_welcome_popup()},1e3)}))}),this.trigger_premium("premium_console"),f("#YLC_popup_cnv").mouseover(function(){f("#YLC_chat_user_"+n.data.active_user_id).removeClass("new-msg").data("count",0).find(".chat-count").empty()}),setInterval(function(){f(".chat-last-online").each(function(e){f(this).html(n.timeago(f(this).data("time")))})},6e4);setInterval(function(){var a=0;n.data.ref_users.once("value",function(e){var t=e.val();null!==t&&f.each(t,function(e,t){t&&"wait"===t.status&&(a+=1)})}),0<a?f("#YLC_queue").html(n.strings.msg.waiting_users.replace(/%d/i,a)).show():f("#YLC_queue").hide()},15e3),f(m).on("beforeunload",function(e){n.data.ref_admins.set(n.total_online_ops()-1)})},login:function(e,i){var n=this;this.manage_connections(),this.data._new_user=e,this.data.auth=this.data.ref.authWithCustomToken(this.data.auth_token,function(e){e?(console.error(e.code,e.message),f("#YLC_connect").removeClass("button-disabled"),f("#YLC_notify").hide().html(e.message).fadeIn(200),n.display_ntf(n.strings.msg.conn_err,"error")):(f("#YLC_notify").html(n.strings.msg.you_offline),f("#YLC_connect").data("logged",0).removeClass("button-disabled"),n.data.logged=!0,n.data.ref_users.once("value",function(e){var t=e.val(),a=0;if(null!==t){var s=Object.keys(t).length;f.each(t,function(e,t){a++,t&&"operator"==t.user_type&&"online"===t.status&&(n.data.online_ops[t.user_id]=t,n.data.ref_admins.set(n.total_online_ops())),a===s&&(n.data.mode="offline",n.check_user(n.opts.user_info.user_id))})}else n.data.mode="offline",n.check_user(n.opts.user_info.user_id);i&&i()}))})},logged_in:function(e){this.trigger_premium("play_sound","connected"),this.listen_msgs(),f("#YLC_notify").hide().empty(),f("#YLC_connect").data("logged",1).data("status","online").removeClass("button-disabled").removeClass("offline").addClass("online"),this.purge_firebase()},logout:function(e){var t=this;this.data.user.user_id&&(t.data.ref_user.off(),t.data.ref_users.off(),t.data.ref_msgs.off(),t.trigger_premium("play_sound","offline"),f("#YLC_notify").html(t.strings.msg.you_offline),f("#YLC_connect").data("logged",0).data("status","offline").removeClass("button-disabled"),t.show_welcome_popup()),f(m).trigger("resize"),t.offline()},be_offline:function(){this.data.mode="offline",this.data.ref_user&&(this.data.ref_user.child("status").set("offline"),this.data.ref_user.child("last_online").set(Firebase.ServerValue.TIMESTAMP),this.data.ref_admins.set(this.total_online_ops())),this.offline()},offline:function(){this.trigger_premium("play_sound","disconnected"),f("#YLC_notify").html(this.strings.msg.you_offline),f("#YLC_connect").data("logged",0).data("status","offline").removeClass("button-disabled").removeClass("online").addClass("offline")},check_user:function(a){var s=this;this.data.ref_user=this.data.ref_users.child(a),this.data.ref_user.once("value",function(e){var t=e.val();t=t||{},s.get_user(a,t)}),this.data.ref_user.child("chat_with").on("value",function(e){var t=e.val();null!=t&&(s.data.user.chat_with=t)}),this.data.ref_users.on("child_removed",function(e){var t=e.val();t&&a===t.user_id&&s.logout()})},get_user:function(e,t,a){var s=this;if(t.user_id)this.data.user=t,this.data.ref_user.child("status").set("offline"),this.data.ref_user.child("user_ip").set(this.opts.user_info.user_ip),this.data.ref_user.child("current_page").set(this.opts.user_info.current_page),this.data.ref_user.child("user_name").set(this.opts.user_info.user_name),this.data.ref_user.child("user_email").set(this.opts.user_info.user_email),this.data.ref_user.child("gravatar").set(this.opts.user_info.gravatar),this.data.ref_user.child("avatar_type").set(this.opts.user_info.avatar_type),this.data.ref_user.child("avatar_image").set(this.opts.user_info.avatar_image),this.data.ref_user.child("vendor_id").set(ylc.active_vendor.vendor_id),this.data.ref_user.child("vendor_name").set(ylc.active_vendor.vendor_name),this.data.mode="offline",this.manage_connections(),this.logged_in(this.data.user),this.listen_users(),a&&a();else if(!0===this.data._new_user){var i={user_id:e,conversation_id:this.data.ref_cnv.push({user_id:e,created_at:Firebase.ServerValue.TIMESTAMP,accepted_at:"",evaluation:"",user_type:"operator",receive_copy:!1}).key(),last_online:"",is_mobile:this.data.is_mobile,chat_with:"free",status:"online",vendor_id:ylc.active_vendor.vendor_id,vendor_name:ylc.active_vendor.vendor_name};for(var n in this.opts.user_info)i[n]=this.opts.user_info[n];this.data.user=i,this.data.ref_user.set(i,function(e){e||(s.data.mode="online",s.logged_in(s.data.user),s.manage_connections(),s.listen_users()),a&&a()})}else this.listen_users()},listen_users:function(){var i=this;this.data.last_changed_id=null,f("#YLC_users > ul").remove(),f("#YLC_users").append("<ul></ul>"),this.data.user_list=f("#YLC_users > ul"),this.data.ref_users.once("value",function(e){var t=e.val(),a=0;if(null!==t){var s=Object.keys(t).length;i.data.online_ops={},f.each(t,function(e,t){a+=1,t&&i.valid_operator(t.vendor_id)&&("operator"===t.user_type&&("online"===t.status?i.data.online_ops[t.user_id]=t:delete i.data.online_ops[t.user_id],i.data.ref_admins.set(i.total_online_ops())),i.add_user_item(t)),a===s&&i.data.ref_users.on("value",function(e){f("#YLC_users > ul").empty();var t=e.val();f.each(t,function(e,t){i.valid_operator(t.vendor_id)&&i.update_user(t)})})})}})},update_user:function(e,t){e&&!e.user_id||(e&&(e.conversation_id?(this.add_user_item(e),"operator"===e.user_type&&("online"===e.status?this.data.online_ops[e.user_id]=e:delete this.data.online_ops[e.user_id],this.data.ref_admins.set(this.total_online_ops())),t||-1==f.inArray(e.user_id,this.objs.checked_user_ids)&&e.user_id!=this.data.user.user_id&&(this.trigger_premium("play_sound","online"),"operator"!=e.user_type&&this.notify(this.strings.msg.new_user_online,e.user_name+" ("+e.user_type+")",null,"user_online"),this.objs.checked_user_ids.push(e.user_id)),this.data.active_user_id===e.user_id&&f("#YLC_active_page").attr("href",e.current_page).find("span").html(e.current_page)):this.clean_user_data(e.user_id)),this.data.last_changed_id=t)},clean_user_data:function(a){var s=this,i=this.data.ref_users.child(a);i.once("value",function(e){var t=e.val();i.remove(),t.conversation_id&&s.ref_cnv.child(t.conversation_id),s.data.ref_msgs.once("value",function(e){var t=e.val();t&&f.each(t,function(e,t){t.user_id===a&&s.data.ref_msgs.child(e).remove()})})})},add_user_item:function(e){if(e.user_id&&this.data.user_list){var t="",a=!1,s="#YLC_chat_user_"+e.user_id;"free"!=e.chat_with&&(null==this.data.online_ops[e.chat_with]?(this.data.ref_users.child(e.user_id).child("chat_with").set("free"),a=!1):(a=e.chat_with!=this.data.user.user_id,t=this.data.online_ops[e.chat_with].user_name));var i=a?" busy":" free",n="offline"===e.status||"wait"===e.status?' - <span class="other-info" data-time="'+e.last_online+'">'+this.timeago(e.last_online)+"</span>":"",r=a?'<br /><span class="other-info">'+this.strings.msg.talking_label.replace(/%s/i,t)+"</span>":"",o="";"operator"==e.user_type&&(i=" op"),ylc.yith_wpv_active&&"0"==ylc.active_vendor.vendor_id&&(o=0==e.vendor_id?"":this.strings.msg.current_shop.replace(/%s/i,e.vendor_name)+" "),f(s).remove();var _=e.user_name||e.user_email||"N/A",c="user-"+e.status+" user-"+e.user_type+i,d=this.set_avatar(e.user_type,{gravatar:e.gravatar,avatar_type:e.avatar_type,avatar_image:e.avatar_image}),u=e.is_mobile?'<span class="ylc-icons ylc-icons-mobile"></span>':"",l=o+(-1<e.user_id.indexOf("usr-")?this.strings.msg.registered:this.strings.msg[e.user_type])+n+r;this.data.user_list.append('<li id="YLC_chat_user_'+e.user_id+'" data-id="'+e.user_id+'" data-cnv-id="'+e.conversation_id+'" data-name="'+_+'" data-count="0" data-chat="'+e.chat_with+'" class="'+c+'"><div class="user-avatar"><img src="'+d+'" /></div><span class="ylc-icons ylc-icons-status"></span>'+u+'<div class="chat-username">'+_+'<span class="chat-count"></span></div><div class="chat-meta">'+l+"</div></li>");var h=f(s);if(e.user_id==this.data.active_user_id)h.addClass("chat-active").removeClass("new-msg").data("count",0).find(".chat-count").empty(),null!=this.objs.new_msgs_count[e.user_id]&&(this.objs.new_msgs_count[e.user_id]=0);else{var v=null!=this.objs.new_msgs_count[e.user_id]?this.objs.new_msgs_count[e.user_id]:0;0<v&&h.data("count",v).find(".chat-count").html("("+v+")")}f(m).trigger("resize")}},notify:function(a,s,i,e){if(Notification&&"Notification"in m)if("granted"===Notification.permission){var t=new Notification(a,{body:s,icon:ylc.plugin_url+"/images/ylc-ico.png",tag:e});i?t.onclick=function(){i()}:t.close(),setTimeout(function(){t.close()},4e3)}else"denied"!==Notification.permission&&Notification.requestPermission(function(e){if("permission"in Notification||(Notification.permission=e),"granted"===e){var t=new Notification(a,{body:s});i?t.onclick=function(){i()}:t.close(),setTimeout(function(){t.close()},4e3)}})},set_avatar:function(e,t){return e="operator"==e?"admin":"user",ylc.is_premium?this.trigger_premium("set_avatar_premium",e,t):this.data.assets_url+"/images/default-avatar-"+e+".png"},time:function(e,t){return this.strings.time[e]&&this.strings.time[e].replace(/%d/i,Math.abs(Math.round(t)))},timeago:function(e){if(!e)return"";var t=.001*((new Date).getTime()-e)>>0,a=t/60,s=a/60,i=s/24,n=i/365;return(t<45&&this.time("seconds",t)||t<90&&this.time("minute",1)||a<45&&this.time("minutes",a)||a<90&&this.time("hour",1)||s<24&&this.time("hours",s)||s<42&&this.time("day",1)||i<30&&this.time("days",i)||i<45&&this.time("month",1)||i<365&&this.time("months",i/30)||n<1.5&&this.time("year",1)||this.time("years",n))+" "+this.strings.time.suffix},listen_msgs:function(){var i=this;this.data.ref_msgs.off(),this.data.ref_msgs.once("value",function(e){var t=e.val(),a=t?Object.keys(t).length:0,s=1;t?f.each(t,function(e,t){t.first_load=!0,i.new_msg(t),a==s&&i.listen_new_msgs(e),s+=1}):i.listen_new_msgs()})},new_msg:function(e,t){var a=this;if(a.valid_operator(e.vendor_id)){var s=f("#YLC_chat_user_"+e.user_id),i=s.find(".chat-count"),n=parseInt(s.data("count"));0!=e.read||e.user_id==a.data.user.user_id||t||(n+=1,a.objs.new_msgs_count[e.user_id]=n,s.addClass("new-msg").data("count",n),i.html("("+n+")"),a.trigger_premium("play_sound","new-msg"),a.notify(a.strings.msg.new_msg,e.user_name+": "+e.msg,null,"new_msg")),a.data.user.conversation_id==e.conversation_id&&(f("#YLC_load_msg").remove(),a.add_msg(e,a.objs.last_user_id,a.objs.last_msg_id),a.objs.last_user_id=e.user_id,a.objs.last_user_id==e.user_id&&a.objs.last_msg_id||(a.objs.last_msg_id=e.msg_id)),t&&a.data.ref_msgs.child(t).child("read").set(!0)}},listen_new_msgs:function(e){var a=this,t=e?a.data.ref_msgs.startAt(null,e):a.data.ref_msgs;t.on("child_added",function(e){var t=e.val();t.id=e.key(),a.new_msg(t),0})},add_msg:function(e,t,a){var s=new Date,i=new Date(e.msg_time),n=i.getHours()+":"+(i.getMinutes()<10?"0":"")+i.getMinutes(),r=this.sanitize_msg(e.msg),o=i.toDateString()==s.toDateString()?n:i.getUTCDate()+" "+this.strings.months_short[i.getUTCMonth()]+", "+n;if(this.objs.cnv){var _=e.user_id==this.data.user.user_id?" chat-you":"",c=i.getUTCDate()+" "+this.strings.months[i.getUTCMonth()]+" "+i.getUTCFullYear()+" "+n,d=this.set_avatar(e.user_type,{gravatar:e.gravatar,avatar_type:e.avatar_type,avatar_image:e.avatar_image});this.objs.cnv.append('<div id="YLC_msg_'+e.id+'" class="chat-cnv-line'+_+'"><div title="'+c+'" class="chat-cnv-time">'+o+'</div><div class="chat-avatar"><img src="'+d+'" /></div> <div class="chat-cnv-msg"><div class="chat-cnv-author">'+e.user_name+"</div>"+r+'</div> </div><div class="chat-clear"></div>').scrollTop(this.objs.cnv.prop("scrollHeight"))}},sanitize_msg:function(e){var t,a,s,i,n={"&":"&amp;","<":"&lt;",">":"&gt;"};return i=/\n/gim,t=/(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gim,a=/(^|[^\/])(www\.[\S]+(\b|$))/gim,s=/(([a-zA-Z0-9\-\_\.])+@[a-zA-Z\_]+?(\.[a-zA-Z]{2,6})+)/gim,e.replace(/[&<>]/g,function(e){return n[e]||e}).replace(i,"<br />").replace(t,'<a href="$1" target="_blank">$1</a>').replace(a,'$1<a href="http://$2" target="_blank">$2</a>').replace(s,'<a href="mailto:$1">$1</a>')},manage_reply_box:function(e){var a,i=this,s=!1,t=f("#YLC_cnv_reply"),n=(a=0,function(e,t){clearTimeout(a),a=setTimeout(e,t)});this.data.ref_cnv.child(this.data.user.conversation_id+"/typing").remove(),t.keydown(function(e){if(13!==e.keyCode||e.shiftKey){if(!s){switch(e.keyCode){case 17:case 18:case 16:case 9:case 8:case 224:case 17:case 91:case 93:return}i.data.ref_cnv.child(i.data.user.conversation_id+"/typing/"+i.data.user.user_id).set(i.data.user.user_name),s=!0}n(function(){i.data.ref_cnv.child(i.data.user.conversation_id+"/typing/"+i.data.user.user_id).remove(),s=!1},1300)}else{e.preventDefault();var t=f(this).val();t&&(f(this).val("").trigger("autosize.resize"),i.push_msg(t),i.data.ref_cnv.child(i.data.user.conversation_id+"/typing/"+i.data.user.user_id).remove())}}),e&&(this.data.ref_cnv.child(e+"/typing").off(),this.data.ref_cnv.child(e).off("child_added")),this.data.ref_cnv.child(this.data.user.conversation_id+"/typing").on("value",function(e){var a=0,t=e.val(),s=t?Object.keys(t).length:0;t?f.each(t,function(e,t){null==e||e==i.data.user.user_id?(s===a&&i.clean_ntf(),a+=1):i.display_ntf(i.strings.msg.writing.replace(/%s/i,t),"typing")}):i.clean_ntf()}),this.data.ref_cnv.child(this.data.user.conversation_id).on("child_added",function(e){"closed"==e.val()&&(f("#YLC_cnv_reply").attr("disabled","disabled"),f(".chat-cnv-input").addClass("chat-disabled"))})},reload_cnv:function(n){var r=this;this.data.ref_msgs.once("value",function(e){new Date;var t=e.val(),a=t?Object.keys(t).length:0,s=0,i=1;t?f.each(t,function(e,t){t.conversation_id==n&&(r.new_msg(t,e),s+=1),a==i&&r.cnv_msgs_loaded(s),i+=1}):r.cnv_msgs_loaded(0)})},cnv_msgs_loaded:function(e){e?f("#YLC_load_msg").empty():f("#YLC_load_msg").html(this.strings.msg.no_msg+".")},push_msg:function(e){this.data.ref_msgs.push({user_id:this.data.user.user_id,user_type:this.data.user.user_type,conversation_id:this.data.user.conversation_id,user_name:this.data.user.user_name||this.data.user.user_email,gravatar:this.data.user.gravatar,avatar_type:this.data.user.avatar_type,avatar_image:this.data.user.avatar_image,msg:e,msg_time:Firebase.ServerValue.TIMESTAMP,vendor_id:ylc.active_vendor.vendor_id,read:!0})},get_user_data:function(e,a){this.data.ref_users.child(e).once("value",function(e){var t=e.val();a(t)})},manage_connections:function(){var t=this;this.data.ref_user&&this.data.ref_conn.on("value",function(e){!0===e.val()?(f("#YLC_firebase_offline").hide(),t.data.ref_user.child("connections").push(!0).onDisconnect().remove(),t.data.ref_user.child("status").set("online"),t.data.ref_user.child("status").onDisconnect().set("offline"),t.data.ref_user.child("last_online").onDisconnect().set(Firebase.ServerValue.TIMESTAMP),t.data.ref_cnv.child(t.data.user.conversation_id+"/typing/"+t.data.user.user_id).onDisconnect().remove()):f("#YLC_firebase_offline").show()})},post:function(t,e,a){f.post(ylc.ajax_url+"?action="+t,e,a,"json").fail(function(e){return console.log(t,": ",e),!1})},trigger_premium:function(e,t,a,s,i,n,r){if(ylc.is_premium)return this.premium[e].call(this,t,a,s,i,n,r)},check_ntf:function(){"Notification"in m&&"denied"!==Notification.permission&&Notification.requestPermission(function(e){"permission"in Notification||(Notification.permission=e)})},display_ntf:function(e,t){var a;switch(t){case"success":case"error":case"typing":a='<span class="ylc-icons ylc-icons-'+t+'"></span> ';break;default:a=""}f("#YLC_popup_ntf").removeClass().addClass("chat-ntf chat-"+t).html(a+e).fadeIn(300)},clean_ntf:function(){f("#YLC_popup_ntf").html("").hide()},clear_user_data:function(n,r){var o=this;this.data.ref_cnv.child(n).once("value",function(e){var t=e.val();if(t){var i=t.user_id;o.data.ref_msgs.once("value",function(e){var t=e.val(),a=t?Object.keys(t).length:0,s=0;t?f.each(t,function(e,t){s+=1,t.conversation_id===n&&o.data.ref_msgs.child(e).remove(),a===s&&r&&r()}):r&&r(),o.data.ref_users.child(i).remove(),o.data.ref_cnv.child(n).remove()})}})},total_online_ops:function(){return this.data.online_ops?Object.keys(this.data.online_ops).length:0},purge_firebase:function(a){var d=this;this.data.ref_users.once("value",function(e){var t=e.val(),s=0,i=[],n=[],r=[],o=a?0:3600;if(null!==t){var _=Object.keys(t).length,c=new Date;f.each(t,function(e,t){if(s++,t)if("offline"===t.status){var a=.001*(c.getTime()-t.last_online)>>0;o<=a&&("operator"!=t.user_type?null!=t.conversation_id?n.push(t.conversation_id):i.push(e):(i.push(e),r.push(t.conversation_id)))}else if("wait"===t.status)if(void 0===t.last_online)i.push(e);else{a=.001*(c.getTime()-t.last_online)>>0;2*o<=a&&i.push(e)}s===_&&(f.each(i,function(e,t){d.data.ref_users.child(t).remove()}),f.each(r,function(e,t){d.data.ref_cnv.child(t).remove()}),f.each(n,function(e,t){ylc.is_premium?d.trigger_premium("save_user_data",t,!0,c.getTime()):d.clear_user_data(t)}))})}})},show_welcome_popup:function(){f("#YLC_popup_cnv").addClass("chat-welcome"),f("#YLC_cnv").hide(),f("#YLC_cnv_bottom").hide(),f("#YLC_sidebar_right").hide()},valid_operator:function(e){return!ylc.yith_wpv_active||(!(!ylc.yith_wpv_active||ylc.active_vendor.vendor_id!==e)||!(!ylc.yith_wpv_active||"0"!=ylc.active_vendor.vendor_id||ylc.vendor_only_chat))}},f.fn[e]=function(){var e;this.data(t)instanceof n||this.data(t,new n),(e=this.data(t)).el=this,e.init()},f(r).ready(function(){f("#YLC_console").ylc_console(),f(m).resize(function(){var e=m.innerHeight,t=f(m).width(),a=0<f("#wpadminbar").length?f("#wpadminbar").height():0,s=e-a-40,i=f("#wpbody-content").width()||f(".yith-wcfm-content").width();0==f("#wpbody-content").length&&(s=m.innerHeight-(a+f("#yith_wcfm-header").outerHeight()+30)),t<766?(f("#YLC_console").css("height",""),f("#YLC_sidebar_left").css("height",""),f("#YLC_popup_cnv").css("height",""),f("#YLC_sidebar_right").css("height",""),f("#YLC_users").css("height",""),f("#YLC_cnv").css("height",250),f(".yith-live-chat-console-container").width(i-12)):(f("#YLC_console").height(s),f("#YLC_sidebar_left").height(s),f("#YLC_popup_cnv").height(s),f("#YLC_sidebar_right").height(s),f("#YLC_users").height(s-110),f("#YLC_cnv").height(s-f("#YLC_cnv_bottom").innerHeight()-30),f(".yith-live-chat-console-container").width(i-20))}).trigger("resize"),f(m).scroll(function(){if(0==f("#wpbody-content").length){var e=0,t=15;0<f("#wpadminbar").length&&(t=15+(e=f("#wpadminbar").height()));var a=f(m).scrollTop();a<=f("#yith_wcfm-header").outerHeight()?(m.innerHeight,f(".yith-live-chat-console-container").css({position:"absolute",top:"auto"})):(m.innerHeight,f("#yith_wcfm-header").outerHeight(),f(".yith-live-chat-console-container").css({position:"fixed",top:t}))}})})}(jQuery,window,document);
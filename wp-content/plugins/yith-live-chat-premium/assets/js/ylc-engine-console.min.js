!function(v,m,r,g){var t="YLC_Console",a={app_id:"",api_key:"",user_info:{user_id:null,user_name:null,user_email:null,gravatar:null,user_type:null,avatar_type:null,avatar_image:null,current_page:null,user_ip:null}},i={show_chat_timer:function(a){var i=this;i.data.ref_cnv.child(a).once("value",function(e){if(null!==e.val()){var t=e.val();""===t.accepted_at?i.data.ref_cnv.child(a).child("accepted_at").set(firebase.database.ServerValue.TIMESTAMP,function(){i.data.ref_cnv.child(a).once("value",function(e){if(null!==e.val()){var t=e.val();i.trigger_premium("set_timer",t.accepted_at)}})}):i.trigger_premium("set_timer",t.accepted_at)}})},premium_console:function(){var e=this;v(".macro-select").select2({placeholder:e.strings.msg.macro_title,allowClear:!0}).on("change",function(){var e=v(this).val();if(""!==e&&null!==e){var t=v("#YLC_cnv_reply"),a=t.val();t.val(a+e),v(this).select2("val",""),t.trigger("autosize.resize").focus()}});for(var t=["connected","disconnected","online","offline","new-msg"],a=0;a<t.length;++a){var i=r.createElement("source"),s=t[a],n=ylc.plugin_url+"/sounds/"+s;e.sounds[s]=r.createElement("audio"),e.sounds[s].canPlayType("audio/mpeg;")?(i.type="audio/mpeg",i.src=n+".mp3"):(i.type="audio/ogg",i.src=n+".ogg"),e.sounds[s].appendChild(i)}},set_timer:function(a){var i=this;i.objs.list_interval=setInterval(function(){var e=new Date,t=i.trigger_premium("chat_duration",a,e.getTime());v("#YLC_timer").html(t),v("#YLC_cnv_reply").is(":disabled")&&clearInterval(i.objs.list_interval)},1e3)},end_chat_console:function(e,t,a,i,s){var n=this;this.trigger_premium("save_user_data",e,t,a,t,function(e){n.objs.working=!1,i.removeClass("button-disabled"),e.error?s.html(e.error):s.html(e.msg),setTimeout(function(){s.fadeOut(2e3),s.html()},1e3),t&&setTimeout(function(){n.show_welcome_popup()},3e3)})},play_sound:function(e){this.sounds[e].play()},chat_duration:function(e,t){if(""===t||""===e)return"00:00:00";var a=.001*(t-e)>>0,i=a/60>>0,s=i/60>>0;return(s=(s%=60)<10?"0"+s:s)+":"+(i=(i%=60)<10?"0"+i:i)+":"+(a=(a%=60)<10?"0"+a:a)},save_user_data:function(o,_,s,c,d){var u=this;this.data.ref_cnv.child(o).once("value",function(e){var t=null!==e.val(),a=e.val();if(t){var r=a.user_id,i=u.trigger_premium("chat_duration",a.accepted_at,s);u.data.ref_users.child(r).once("value",function(e){var n=e.val();n.created_at=a.created_at,n.evaluation=a.evaluation,n.duration=i,n.receive_copy=a.receive_copy,n.send_email=c,u.data.ref_msgs.once("value",function(e){var t=e.val(),a=t?Object.keys(t).length:0,i=0,s={};t?v.each(t,function(e,t){i+=1,t.conversation_id===o&&(s[e]=t,_&&u.data.ref_msgs.child(e).remove()),a===i&&(n.msgs=s,u.post("ylc_ajax_save_chat",n,function(e){d&&d(e)}))}):d&&d({}),_&&(u.data.ref_users.child(r).remove(),u.data.ref_cnv.child(o).remove())})})}else d&&d({})})},set_avatar_premium:function(e,t){var a;if("admin"!==e)a="https://www.gravatar.com/avatar/"+t.gravatar+".jpg?s=60&d="+ylc.default_user_avatar;else switch(t.avatar_type){case"gravatar":a="https://www.gravatar.com/avatar/"+t.gravatar+".jpg?s=60&d="+ylc.default_admin_avatar;break;case"image":a=t.avatar_image;break;default:a=""!==ylc.company_avatar?ylc.company_avatar:this.data.assets_url+"/images/default-avatar-"+e+".png"}return a}};function e(e){this.element=e,this.opts=v.extend(a,ylc.defaults),this.premium=v.extend({},i),this._name=t,this.init()}e.prototype={init:function(){this.data={auth:null,ref:null,is_mobile:!1,active_user_id:0,mode:"offline",logged:!1,assets_url:ylc.plugin_url,user:{},online_ops:{}},this.strings=ylc.strings,this.sounds={},this.objs={last_cnv_id:null,last_user_id:null,last_msg_id:null,right_sidebar_html:"",list_interval:null,working:!1,checked_user_ids:[],new_msgs_count:{}};var t=this;v("#YLC_connect").click(function(e){e.preventDefault(),v("#YLC_notify").show().html(t.strings.msg.connecting+"..."),v(this).data("logged")?v(this).data("status","online")&&t.be_offline():t.login(!0)}),/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)&&(this.data.is_mobile=!0),this.post("ylc_ajax_get_token",{},function(e){e.error||(t.data.auth_token=e.token,t.check_ntf(),t.auth())})},auth:function(e){if(null===this.data.ref){var t={apiKey:this.opts.api_key,authDomain:this.opts.app_id+".firebaseapp.com",databaseURL:"https://"+this.opts.app_id+".firebaseio.com"};firebase.initializeApp(t),this.data.ref=firebase.database().ref(),this.data.ref_conn=firebase.database().ref(".info/connected"),this.data.ref_cnv=firebase.database().ref("chat_sessions"),this.data.ref_msgs=firebase.database().ref("chat_messages"),this.data.ref_users=firebase.database().ref("chat_users"),this.data.ref_admins=firebase.database().ref("active_admins")}this.login(!1,e),this.after_load()},after_load:function(){var s=this;v(r).on("keydown","#YLC_cnv_reply",function(){v(this).trigger("autosize.resize"),v(m).trigger("resize")}),v(r).on("focus","#YLC_cnv_reply",function(){v(this).autosize({append:""})}),v(r).on("click","#YLC_users li.free, #YLC_users li.busy",function(){var i=v(this);null!==s.objs.list_interval&&clearInterval(s.objs.list_interval),s.get_user_data(v(this).data("id"),function(e){var t=v("#YLC_end_chat"),a=v("#YLC_cnv_bottom");s.data.active_user_id&&v("#YLC_chat_user_"+s.data.active_user_id).removeClass("chat-active"),i.addClass("chat-active").removeClass("new-msg").data("count",0).find(".chat-count").empty(),v("#YLC_popup_cnv").removeClass("chat-welcome"),v("#YLC_cnv_reply").val("").focus().removeAttr("disabled"),v(".chat-cnv-input").removeClass("chat-disabled"),v(".sidebar-info.info-name > span").html(e.user_name),v(".sidebar-info.info-ip > span").html(e.user_ip),v(".sidebar-info.info-email > a").html(e.user_email).attr("href","mailto:"+e.user_email),v(".sidebar-info.info-page > a").html(e.current_page?e.current_page:"N/A").attr("href",e.current_page?e.current_page:"#"),t.attr("data-cnv-id",i.data("cnv-id")),v("#YLC_save").attr("data-cnv-id",i.data("cnv-id")),v("#YLC_active_cnv").val(i.data("cnv-id")),s.objs.cnv=v("#YLC_cnv"),s.objs.cnv.html(""),s.data.user.conversation_id=i.data("cnv-id"),s.data.active_user_id=i.data("id"),s.reload_cnv(i.data("cnv-id")),s.manage_reply_box(s.objs.last_cnv_id),s.objs.last_cnv_id=i.data("cnv-id"),s.objs.cnv.show(),a.find("img").attr("src",s.set_avatar(s.data.user.user_type,{gravatar:s.data.user.gravatar,avatar_type:s.data.user.avatar_type,avatar_image:s.data.user.avatar_image})),a.show(),v("#YLC_sidebar_right").show(),"free"===i.data("chat")?s.data.ref_users.child(i.data("id")).child("chat_with").set(s.data.user.user_id):i.data("chat")===s.data.user.user_id?t.show():t.hide(),s.trigger_premium("show_chat_timer",i.data("cnv-id")),v(m).trigger("resize")})}),v(r).on("click","#YLC_save, #YLC_end_chat",function(){var e=v(this),t=v("#YLC_save_ntf"),a="YLC_end_chat"===v(this).attr("id"),i=(new Date).getTime();t.show(),s.objs.working?t.html(s.strings.msg.please_wait+"..."):(s.objs.working=!0,v(this).addClass("button-disabled"),t.html(s.strings.msg.saving+"..."),a&&null!==s.objs.list_interval&&clearInterval(s.objs.list_interval),ylc.is_premium?s.trigger_premium("end_chat_console",v("#YLC_active_cnv").val(),a,i,e,t):s.clear_user_data(v("#YLC_active_cnv").val(),function(){s.objs.working=!1,e.removeClass("button-disabled"),setTimeout(function(){t.fadeOut(500)},100),setTimeout(function(){s.show_welcome_popup()},1e3)}))}),this.trigger_premium("premium_console"),v("#YLC_popup_cnv").mouseover(function(){v("#YLC_chat_user_"+s.data.active_user_id).removeClass("new-msg").data("count",0).find(".chat-count").empty()}),setInterval(function(){v(".chat-last-online").each(function(){v(this).html(s.timeago(v(this).data("time")))})},6e4);setInterval(function(){var a=0;s.data.ref_users.once("value",function(e){var t=e.val();null!==t&&v.each(t,function(e,t){t&&"wait"===t.status&&(a+=1)})}),0<a?v("#YLC_queue").html(s.strings.msg.waiting_users.replace(/%d/i,a)).show():v("#YLC_queue").hide()},15e3),v(m).on("beforeunload",function(e){s.data.ref_admins.set(s.total_online_ops()-1)})},login:function(e,s){var n=this;this.manage_connections(),this.data._new_user=e,firebase.auth().signInWithCustomToken(this.data.auth_token).then(function(){v("#YLC_notify").html(n.strings.msg.you_offline),v("#YLC_connect").data("logged",0).removeClass("button-disabled"),n.data.logged=!0,n.data.ref_users.once("value",function(e){var t=e.val(),a=0;if(null!==t){var i=Object.keys(t).length;v.each(t,function(e,t){a++,t&&"operator"===t.user_type&&"online"===t.status&&(n.data.online_ops[t.user_id]=t,n.data.ref_admins.set(n.total_online_ops())),a===i&&(n.data.mode="offline",n.check_user(n.opts.user_info.user_id))})}else n.data.mode="offline",n.check_user(n.opts.user_info.user_id);s&&s()})})["catch"](function(e){console.error(e.code,e.message),v("#YLC_connect").removeClass("button-disabled"),v("#YLC_notify").hide().html(e.message).fadeIn(200),n.display_ntf(n.strings.msg.conn_err,"error")})},logged_in:function(){this.trigger_premium("play_sound","connected"),this.listen_msgs(),v("#YLC_notify").hide().empty(),v("#YLC_connect").data("logged",1).data("status","online").removeClass("button-disabled").removeClass("offline").addClass("online"),this.purge_firebase()},logout:function(){var e=this;this.data.user.user_id&&(e.data.ref_user.off(),e.data.ref_users.off(),e.data.ref_msgs.off(),e.trigger_premium("play_sound","offline"),v("#YLC_notify").html(e.strings.msg.you_offline),v("#YLC_connect").data("logged",0).data("status","offline").removeClass("button-disabled"),e.show_welcome_popup()),v(m).trigger("resize"),e.offline()},be_offline:function(){this.data.mode="offline",this.data.ref_user&&(this.data.ref_user.child("status").set("offline"),this.data.ref_user.child("last_online").set(firebase.database.ServerValue.TIMESTAMP),this.data.ref_admins.set(this.total_online_ops())),this.offline()},offline:function(){this.trigger_premium("play_sound","disconnected"),v("#YLC_notify").html(this.strings.msg.you_offline),v("#YLC_connect").data("logged",0).data("status","offline").removeClass("button-disabled").removeClass("online").addClass("offline")},check_user:function(a){var i=this;this.data.ref_user=this.data.ref_users.child(a),this.data.ref_user.once("value",function(e){var t=e.val();t=t||{},i.get_user(a,t)}),this.data.ref_user.child("chat_with").on("value",function(e){var t=e.val();null!==t&&(i.data.user.chat_with=t)}),this.data.ref_users.on("child_removed",function(e){var t=e.val();t&&a===t.user_id&&i.logout()})},get_user:function(e,t,a){var i=this;if(t.user_id)this.data.user=t,this.data.ref_user.child("status").set("offline"),this.data.ref_user.child("user_ip").set(this.opts.user_info.user_ip),this.data.ref_user.child("current_page").set(this.opts.user_info.current_page),this.data.ref_user.child("user_name").set(this.opts.user_info.user_name),this.data.ref_user.child("user_email").set(this.opts.user_info.user_email),this.data.ref_user.child("gravatar").set(this.opts.user_info.gravatar),this.data.ref_user.child("avatar_type").set(this.opts.user_info.avatar_type),this.data.ref_user.child("avatar_image").set(this.opts.user_info.avatar_image),this.data.ref_user.child("vendor_id").set(ylc.active_vendor.vendor_id),this.data.ref_user.child("vendor_name").set(ylc.active_vendor.vendor_name),this.data.mode="offline",this.manage_connections(),this.logged_in(),this.listen_users(),a&&a();else if(!0===this.data._new_user){var s={user_id:e,conversation_id:this.data.ref_cnv.push({user_id:e,created_at:firebase.database.ServerValue.TIMESTAMP,accepted_at:"",evaluation:"",user_type:"operator",receive_copy:!1}).key,last_online:"",is_mobile:this.data.is_mobile,chat_with:"free",status:"online",vendor_id:ylc.active_vendor.vendor_id,vendor_name:ylc.active_vendor.vendor_name};for(var n in this.opts.user_info)s[n]=this.opts.user_info[n];this.data.user=s,this.data.ref_user.set(s,function(e){e||(i.data.mode="online",i.logged_in(),i.manage_connections(),i.listen_users()),a&&a()})}else this.listen_users()},listen_users:function(){var s=this,e=v("#YLC_users");this.data.last_changed_id=null,e.find("ul").remove(),e.append("<ul></ul>"),this.data.user_list=e.find("ul"),this.data.ref_users.once("value",function(e){var t=e.val(),a=0;if(null!==t){var i=Object.keys(t).length;s.data.online_ops={},v.each(t,function(e,t){a+=1,t&&s.valid_operator(t.vendor_id)&&("operator"===t.user_type&&("online"===t.status?s.data.online_ops[t.user_id]=t:delete s.data.online_ops[t.user_id],s.data.ref_admins.set(s.total_online_ops())),s.add_user_item(t)),a===i&&s.data.ref_users.on("value",function(e){v("#YLC_users").find("ul").empty();var t=e.val();v.each(t,function(e,t){s.valid_operator(t.vendor_id)&&s.update_user(t)})})})}})},update_user:function(e,t){e&&!e.user_id||(e&&(e.conversation_id?(this.add_user_item(e),"operator"===e.user_type&&("online"===e.status?this.data.online_ops[e.user_id]=e:delete this.data.online_ops[e.user_id],this.data.ref_admins.set(this.total_online_ops())),t||-1===v.inArray(e.user_id,this.objs.checked_user_ids)&&e.user_id!==this.data.user.user_id&&(this.trigger_premium("play_sound","online"),"operator"!==e.user_type&&this.notify(this.strings.msg.new_user_online,e.user_name+" ("+e.user_type+")",null,"user_online"),this.objs.checked_user_ids.push(e.user_id)),this.data.active_user_id===e.user_id&&v("#YLC_active_page").attr("href",e.current_page).find("span").html(e.current_page)):this.clean_user_data(e.user_id)),this.data.last_changed_id=t)},clean_user_data:function(a){var i=this,s=this.data.ref_users.child(a);s.once("value",function(e){var t=e.val();s.remove(),t.conversation_id&&i.ref_cnv.child(t.conversation_id),i.data.ref_msgs.once("value",function(e){var t=e.val();t&&v.each(t,function(e,t){t.user_id===a&&i.data.ref_msgs.child(e).remove()})})})},add_user_item:function(e){if(e.user_id&&this.data.user_list&&e.user_id!==this.opts.user_info.user_id){var t="",a=!1,i="#YLC_chat_user_"+e.user_id;"free"!==e.chat_with&&(null===this.data.online_ops[e.chat_with]||this.data.online_ops[e.chat_with]===g?(this.data.ref_users.child(e.user_id).child("chat_with").set("free"),a=!1):(a=e.chat_with!==this.data.user.user_id,t=this.data.online_ops[e.chat_with].user_name));var s=a?" busy":" free",n="offline"===e.status||"wait"===e.status?' - <span class="other-info" data-time="'+e.last_online+'">'+this.timeago(e.last_online)+"</span>":"",r=a?'<br /><span class="other-info">'+this.strings.msg.talking_label.replace(/%s/i,t)+"</span>":"",o="";"operator"===e.user_type&&(s=" op"),ylc.yith_wpv_active&&"0"===ylc.active_vendor.vendor_id&&(o=0===e.vendor_id?"":this.strings.msg.current_shop.replace(/%s/i,e.vendor_name)+" "),v(i).remove();var _=e.user_name||e.user_email||"N/A",c="user-"+e.status+" user-"+e.user_type+s,d=this.set_avatar(e.user_type,{gravatar:e.gravatar,avatar_type:e.avatar_type,avatar_image:e.avatar_image}),u=e.is_mobile?'<span class="ylc-icons ylc-icons-mobile"></span>':"",l=o+(-1<e.user_id.indexOf("usr-")?this.strings.msg.registered:this.strings.msg[e.user_type])+n+r;this.data.user_list.append('<li id="YLC_chat_user_'+e.user_id+'" data-id="'+e.user_id+'" data-cnv-id="'+e.conversation_id+'" data-name="'+_+'" data-count="0" data-chat="'+e.chat_with+'" class="'+c+'"><div class="user-avatar"><img src="'+d+'" /></div><span class="ylc-icons ylc-icons-status"></span>'+u+'<div class="chat-username">'+_+'<span class="chat-count"></span></div><div class="chat-meta">'+l+"</div></li>");var h=v(i);if(e.user_id===this.data.active_user_id)h.addClass("chat-active").removeClass("new-msg").data("count",0).find(".chat-count").empty(),null!==this.objs.new_msgs_count[e.user_id]&&(this.objs.new_msgs_count[e.user_id]=0);else{var f=null!==this.objs.new_msgs_count[e.user_id]?this.objs.new_msgs_count[e.user_id]:0;0<f&&h.data("count",f).find(".chat-count").html("("+f+")")}v(m).trigger("resize")}},notify:function(a,i,s,e){if(Notification&&"Notification"in m)if("granted"===Notification.permission){var t=new Notification(a,{body:i,icon:ylc.plugin_url+"/images/ylc-ico.png",tag:e});s?t.onclick=function(){s()}:t.close(),setTimeout(function(){t.close()},4e3)}else"denied"!==Notification.permission&&Notification.requestPermission(function(e){if("permission"in Notification||(Notification.permission=e),"granted"===e){var t=new Notification(a,{body:i});s?t.onclick=function(){s()}:t.close(),setTimeout(function(){t.close()},4e3)}})},set_avatar:function(e,t){return e="operator"===e?"admin":"user",ylc.is_premium?this.trigger_premium("set_avatar_premium",e,t):this.data.assets_url+"/images/default-avatar-"+e+".png"},time:function(e,t){return this.strings.time[e]&&this.strings.time[e].replace(/%d/i,Math.abs(Math.round(t)))},timeago:function(e){if(!e)return"";var t=.001*((new Date).getTime()-e)>>0,a=t/60,i=a/60,s=i/24,n=s/365;return(t<45&&this.time("seconds",t)||t<90&&this.time("minute",1)||a<45&&this.time("minutes",a)||a<90&&this.time("hour",1)||i<24&&this.time("hours",i)||i<42&&this.time("day",1)||s<30&&this.time("days",s)||s<45&&this.time("month",1)||s<365&&this.time("months",s/30)||n<1.5&&this.time("year",1)||this.time("years",n))+" "+this.strings.time.suffix},listen_msgs:function(){var s=this;this.data.ref_msgs.off(),this.data.ref_msgs.once("value",function(e){var t=e.val(),a=t?Object.keys(t).length:0,i=1;t?v.each(t,function(e,t){t.first_load=!0,s.new_msg(t),a===i&&s.listen_new_msgs(e),i+=1}):s.listen_new_msgs()})},new_msg:function(e,t){var a=this;if(a.valid_operator(e.vendor_id)){var i=v("#YLC_chat_user_"+e.user_id),s=i.find(".chat-count"),n=parseInt(i.data("count"));!1!==e.read||e.user_id===a.data.user.user_id||t||(n+=1,a.objs.new_msgs_count[e.user_id]=n,i.addClass("new-msg").data("count",n),s.html("("+n+")"),a.trigger_premium("play_sound","new-msg"),a.notify(a.strings.msg.new_msg,e.user_name+": "+e.msg,null,"new_msg")),a.data.user.conversation_id===e.conversation_id&&(v("#YLC_load_msg").remove(),a.add_msg(e),a.objs.last_user_id=e.user_id,a.objs.last_user_id===e.user_id&&a.objs.last_msg_id||(a.objs.last_msg_id=e.msg_id)),t&&a.data.ref_msgs.child(t).child("read").set(!0)}},listen_new_msgs:function(e){var a=this,t=e?a.data.ref_msgs.startAt(null,e):a.data.ref_msgs;t.on("child_added",function(e){var t=e.val();t.id=e.key,a.new_msg(t),0})},add_msg:function(e){var t=new Date,a=new Date(e.msg_time),i=a.getHours()+":"+(a.getMinutes()<10?"0":"")+a.getMinutes(),s=this.sanitize_msg(e.msg),n=a.toDateString()===t.toDateString()?i:a.getUTCDate()+" "+this.strings.months_short[a.getUTCMonth()]+", "+i;if(this.objs.cnv){var r=e.user_id===this.data.user.user_id?" chat-you":"",o=a.getUTCDate()+" "+this.strings.months[a.getUTCMonth()]+" "+a.getUTCFullYear()+" "+i,_=this.set_avatar(e.user_type,{gravatar:e.gravatar,avatar_type:e.avatar_type,avatar_image:e.avatar_image});this.objs.cnv.append('<div id="YLC_msg_'+e.id+'" class="chat-cnv-line'+r+'"><div title="'+o+'" class="chat-cnv-time">'+n+'</div><div class="chat-avatar"><img src="'+_+'" /></div> <div class="chat-cnv-msg"><div class="chat-cnv-author">'+e.user_name+"</div>"+s+'</div> </div><div class="chat-clear"></div>').scrollTop(this.objs.cnv.prop("scrollHeight"))}},sanitize_msg:function(e){var t,a,i,s,n={"&":"&amp;","<":"&lt;",">":"&gt;"};return s=/\n/gim,t=/(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gim,a=/(^|[^\/])(www\.[\S]+(\b|$))/gim,i=/(([a-zA-Z0-9\-\_\.])+@[a-zA-Z\_]+?(\.[a-zA-Z]{2,6})+)/gim,e.replace(/[&<>]/g,function(e){return n[e]||e}).replace(s,"<br />").replace(t,'<a href="$1" target="_blank">$1</a>').replace(a,'$1<a href="http://$2" target="_blank">$2</a>').replace(i,'<a href="mailto:$1">$1</a>')},manage_reply_box:function(e){var a,s=this,i=!1,t=v("#YLC_cnv_reply"),n=(a=0,function(e,t){clearTimeout(a),a=setTimeout(e,t)});this.data.ref_cnv.child(this.data.user.conversation_id+"/typing").remove(),t.keydown(function(e){if(13!==e.keyCode||e.shiftKey){if(!i){switch(e.keyCode){case 18:case 16:case 9:case 8:case 224:case 17:case 91:case 93:return}s.data.ref_cnv.child(s.data.user.conversation_id+"/typing/"+s.data.user.user_id).set(s.data.user.user_name),i=!0}n(function(){s.data.ref_cnv.child(s.data.user.conversation_id+"/typing/"+s.data.user.user_id).remove(),i=!1},1300)}else{e.preventDefault();var t=v(this).val();t&&(v(this).val("").trigger("autosize.resize"),s.push_msg(t),s.data.ref_cnv.child(s.data.user.conversation_id+"/typing/"+s.data.user.user_id).remove())}}),e&&(this.data.ref_cnv.child(e+"/typing").off(),this.data.ref_cnv.child(e).off("child_added")),this.data.ref_cnv.child(this.data.user.conversation_id+"/typing").on("value",function(e){var a=0,t=e.val(),i=t?Object.keys(t).length:0;t?v.each(t,function(e,t){null===e||e===s.data.user.user_id?(i===a&&s.clean_ntf(),a+=1):s.display_ntf(s.strings.msg.writing.replace(/%s/i,t),"typing")}):s.clean_ntf()}),this.data.ref_cnv.child(this.data.user.conversation_id).on("child_added",function(e){"closed"===e.val()&&(v("#YLC_cnv_reply").attr("disabled","disabled"),v(".chat-cnv-input").addClass("chat-disabled"))})},reload_cnv:function(n){var r=this;this.data.ref_msgs.once("value",function(e){var t=e.val(),a=t?Object.keys(t).length:0,i=0,s=1;t?v.each(t,function(e,t){t.conversation_id===n&&(r.new_msg(t,e),i+=1),a===s&&r.cnv_msgs_loaded(i),s+=1}):r.cnv_msgs_loaded(0)})},cnv_msgs_loaded:function(e){e?v("#YLC_load_msg").empty():v("#YLC_load_msg").html(this.strings.msg.no_msg+".")},push_msg:function(e){this.data.ref_msgs.push({user_id:this.data.user.user_id,user_type:this.data.user.user_type,conversation_id:this.data.user.conversation_id,user_name:this.data.user.user_name||this.data.user.user_email,gravatar:this.data.user.gravatar,avatar_type:this.data.user.avatar_type,avatar_image:this.data.user.avatar_image,msg:e,msg_time:firebase.database.ServerValue.TIMESTAMP,vendor_id:ylc.active_vendor.vendor_id,read:!0})},get_user_data:function(e,a){this.data.ref_users.child(e).once("value",function(e){var t=e.val();a(t)})},manage_connections:function(){var t=this;this.data.ref_user&&this.data.ref_conn.on("value",function(e){!0===e.val()?(v("#YLC_firebase_offline").hide(),t.data.ref_user.child("connections").push(!0).onDisconnect().remove(),t.data.ref_user.child("status").set("online"),t.data.ref_user.child("status").onDisconnect().set("offline"),t.data.ref_user.child("last_online").onDisconnect().set(firebase.database.ServerValue.TIMESTAMP),t.data.ref_cnv.child(t.data.user.conversation_id+"/typing/"+t.data.user.user_id).onDisconnect().remove()):v("#YLC_firebase_offline").show()})},post:function(e,t,a){v.post(ylc.ajax_url+"?action="+e,t,a,"json").fail(function(e){return console.log(mode,": ",e),!1})},trigger_premium:function(e,t,a,i,s,n,r){if(ylc.is_premium)return this.premium[e].call(this,t,a,i,s,n,r)},check_ntf:function(){"Notification"in m&&"denied"!==Notification.permission&&Notification.requestPermission(function(e){"permission"in Notification||(Notification.permission=e)})},display_ntf:function(e,t){var a;switch(t){case"success":case"error":case"typing":a='<span class="ylc-icons ylc-icons-'+t+'"></span> ';break;default:a=""}v("#YLC_popup_ntf").removeClass().addClass("chat-ntf chat-"+t).html(a+e).fadeIn(300)},clean_ntf:function(){v("#YLC_popup_ntf").html("").hide()},clear_user_data:function(n,r){var o=this;this.data.ref_cnv.child(n).once("value",function(e){var t=e.val();if(t){var s=t.user_id;o.data.ref_msgs.once("value",function(e){var t=e.val(),a=t?Object.keys(t).length:0,i=0;t?v.each(t,function(e,t){i+=1,t.conversation_id===n&&o.data.ref_msgs.child(e).remove(),a===i&&r&&r()}):r&&r(),o.data.ref_users.child(s).remove(),o.data.ref_cnv.child(n).remove()})}})},total_online_ops:function(){return this.data.online_ops?Object.keys(this.data.online_ops).length:0},purge_firebase:function(a){var d=this;this.data.ref_users.once("value",function(e){var t=e.val(),i=0,s=[],n=[],r=[],o=a?0:3600;if(null!==t){var _=Object.keys(t).length,c=new Date;v.each(t,function(e,t){if(i++,t){var a=.001*(c.getTime()-t.last_online)>>0;"offline"===t.status?o<=a&&("operator"!==t.user_type?null!==t.conversation_id?n.push(t.conversation_id):s.push(e):(s.push(e),r.push(t.conversation_id))):"wait"===t.status&&(t.last_online===g||2*o<=a)&&s.push(e)}i===_&&(v.each(s,function(e,t){d.data.ref_users.child(t).remove()}),v.each(r,function(e,t){d.data.ref_cnv.child(t).remove()}),v.each(n,function(e,t){ylc.is_premium?d.trigger_premium("save_user_data",t,!0,c.getTime()):d.clear_user_data(t)}))})}})},show_welcome_popup:function(){v("#YLC_popup_cnv").addClass("chat-welcome"),v("#YLC_cnv").hide(),v("#YLC_cnv_bottom").hide(),v("#YLC_sidebar_right").hide()},valid_operator:function(e){if(!ylc.yith_wpv_active)return!0;if(ylc.yith_wpv_active){if(ylc.active_vendor.vendor_id===e)return!0;if("0"===ylc.active_vendor.vendor_id&&!ylc.vendor_only_chat)return!0}return!1}},v.fn[t]=function(){return this.each(function(){v.data(this,"plugin_"+t)||v.data(this,"plugin_"+t,new e(this))})},v(r).ready(function(){v("body").addClass("folded"),v("#YLC_console").YLC_Console(),v(m).resize(function(){var e=m.innerHeight,t=v(m).width(),a=0<v("#wpadminbar").length?v("#wpadminbar").height():0,i=e-a-40,s=v("#wpbody-content").width()||v(".yith-wcfm-content").width();0===v("#wpbody-content").length&&(i=m.innerHeight-(a+v("#yith_wcfm-header").outerHeight()+30)),t<766?(v("#YLC_console").css("height",""),v("#YLC_sidebar_left").css("height",""),v("#YLC_popup_cnv").css("height",""),v("#YLC_sidebar_right").css("height",""),v("#YLC_users").css("height",""),v("#YLC_cnv").css("height",250),v(".yith-live-chat-console-container").width(s-12)):(v("#YLC_console").height(i),v("#YLC_sidebar_left").height(i),v("#YLC_popup_cnv").height(i),v("#YLC_sidebar_right").height(i),v("#YLC_users").height(i-110),v("#YLC_cnv").height(i-v("#YLC_cnv_bottom").innerHeight()-30),v(".yith-live-chat-console-container").width(s-20))}).trigger("resize"),v(m).scroll(function(){if(0===v("#wpbody-content").length){var e=0,t=15;0<v("#wpadminbar").length&&(t=15+(e=v("#wpadminbar").height()));var a=v(m).scrollTop();a<=v("#yith_wcfm-header").outerHeight()?(m.innerHeight,v(".yith-live-chat-console-container").css({position:"absolute",top:"auto"})):(m.innerHeight,v("#yith_wcfm-header").outerHeight(),v(".yith-live-chat-console-container").css({position:"fixed",top:t}))}})})}(jQuery,window,document);